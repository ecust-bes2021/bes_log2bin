# Log2bin - 串口日志抓取工具

## 项目简介

Log2bin是一个专门用于PCT挂测抓取UE日志的工具，通过编译开源ACE库并封装串口通信所需接口，实现高效的串口数据采集和二进制文件存储。

## 主要功能

- **串口通信**: 基于ACE库封装的高性能串口通信接口
- **实时数据采集**: 支持高波特率（如12000000 bps）的实时数据抓取
- **二进制文件存储**: 将抓取的日志数据直接保存为二进制文件
- **配置化管理**: 通过YAML配置文件管理串口参数和输出设置
- **心跳检测**: 具备写入线程心跳检测机制，确保数据完整性
- **错误恢复**: 支持文件写入错误自动恢复和重试机制

## 核心特性

### 1. 多线程架构
- **数据回调线程**: 处理串口数据接收回调
- **写入线程**: 专门负责文件写入操作，避免阻塞数据接收
- **主控制线程**: 负责整体流程控制和状态监控

### 2. 内存管理
- 使用线程安全的队列缓冲区（最大4096条目）
- 防止内存无限增长的保护机制
- 高效的数据传输和处理

### 3. 文件管理
- 按时间戳自动命名文件（格式：YYYY-MM-DD_HHMMSS-后缀.bin）
- 支持自定义文件后缀
- 自动创建输出目录
- 文件写入状态实时监控

## 项目结构

```
bes_log2bin/
├── log2bin_script.py          # 主程序（具备心跳检测）
├── bes_log_to_bin_script.py   # 简化版本（无心跳检测）
├── log2bin_copy.py            # 备份版本
├── config.yaml                # 配置文件
├── SerialPortLib_x64.dll      # 串口通信动态库
├── ACE.dll                    # ACE库依赖
├── build.py                   # 打包脚本
├── logs/                      # 日志输出目录
└── dist/                      # 打包输出目录
```

## 安装与配置

### 1. 环境要求
- Python 3.6+
- Windows 64位系统
- 串口设备驱动

### 2. 依赖库
```bash
pip install pyyaml
```

### 3. 配置文件设置

编辑 `config.yaml` 文件：

```yaml
# 串口配置
com_port: COM7                    # 串口号
baud_rate: 12000000              # 波特率
# 输出目录路径
output_dir: D:\workdir\ACE-8.0.2\bes_log2bin\logs
# 文件后缀名(可选)
suffix: test
```

## 使用方法

### 1. 直接运行
```bash
python log2bin_script.py
```

### 2. 使用可执行文件
```bash
log2bin_script.exe
```

### 3. 停止工具
```bash
taskkill /f /im log2bin_script.exe
```

## 打包部署

### 使用build.py脚本打包
```bash
python build.py
```

### 手动打包命令
```bash
pyinstaller --onefile --add-binary "SerialPortLib_x64.dll;." --add-data "config.yaml;." log2bin_script.py
```

## 输出文件格式

生成的日志文件命名规则：
- 格式：`YYYY-MM-DD_HHMMSS-后缀.bin`
- 示例：`2025-04-08_111238-3601PCT.bin`
- 位置：配置文件中指定的output_dir目录

## 技术实现

### 1. 串口通信
- 基于ACE库的高性能串口接口
- 支持高波特率通信（最高12Mbps）
- 异步数据接收机制

### 2. 数据处理流程
```
串口数据接收 → 回调函数 → 数据队列 → 写入线程 → 二进制文件
```

### 3. 错误处理
- 串口连接异常检测
- 文件写入错误自动恢复
- 写入线程心跳监控
- 内存溢出保护

## 版本历史

### [1.0.1] - 2025-04-09
#### 更改
- 实现在配置文件中配置好工具的默认端口、波特率、日志文件后缀、日志生成路径
- 运行期间工具抓取日志按时间-后缀命名文件

#### 新增
- 修改打包方式解决动态库找不到的问题
- 添加版本号管理

## 故障排除

### 常见问题

1. **找不到串口设备**
   - 检查设备管理器中串口是否正常
   - 确认串口号配置正确
   - 检查串口是否被其他程序占用

2. **动态库加载失败**
   - 确保SerialPortLib_x64.dll和ACE.dll在程序目录
   - 检查系统是否安装Visual C++运行库

3. **文件写入失败**
   - 检查输出目录权限
   - 确保磁盘空间充足
   - 检查文件路径是否有效

4. **数据丢失**
   - 检查波特率设置是否匹配
   - 监控内存使用情况
   - 查看心跳检测日志

## 开发说明

### 代码结构
- `log2bin_script.py`: 主程序，包含完整的心跳检测和错误恢复机制
- `bes_log_to_bin_script.py`: 简化版本，适用于基础使用场景
- `log2bin_copy.py`: 带详细注释的版本，便于理解和修改

### 扩展开发
- 支持多串口同时采集
- 添加数据压缩功能
- 实现远程监控接口
- 增加数据格式转换功能

## 许可证

本项目遵循相关开源协议，具体请查看LICENSE文件。
